{% extends "base.html" %}

{% block title %}Dashboard - Archeion Now{% endblock %}

{% block extra_css %}
<style>
    .run-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .run-section h3 {
        margin-bottom: 15px;
        color: white;
    }
    
    .run-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .run-input {
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        width: 120px;
    }
    
    .status-indicator {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
    }
    
    .status-idle {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .status-running {
        background: #ffc107;
        color: #333;
        animation: pulse 2s infinite;
    }
    
    .status-completed {
        background: #28a745;
    }
    
    .status-error {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .job-message {
        margin-top: 10px;
        font-size: 14px;
        opacity: 0.9;
    }
    
    .status-killed {
        background: #ff9800;
    }
    
    .progress-output {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 12px;
        line-height: 1.5;
        display: none;
    }
    
    .progress-output.active {
        display: block;
    }
    
    .progress-line {
        margin: 2px 0;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    
    .progress-line.status {
        color: #ffc107;
        font-weight: bold;
    }
    
    .progress-line.error {
        color: #ff6b6b;
    }
    
    .kill-btn {
        background: #dc3545 !important;
        margin-left: 10px;
    }
    
    .kill-btn:hover {
        background: #c82333 !important;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 30px; color: #333;">Dashboard</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="margin-bottom: 10px; color: #667eea;">ðŸ“„ Papers</h3>
        <p style="font-size: 32px; font-weight: bold; color: #333;">{{ paper_count }}</p>
        <p style="color: #666; margin-top: 5px;">Total papers processed</p>
    </div>
</div>

<div class="run-section">
    <h3>ðŸš€ Run Paper Processing</h3>
    <div class="run-controls">
        <button onclick="startProcessing()" class="btn" id="run-btn" style="background: white; color: #667eea;">
            Start Processing
        </button>
        <button onclick="startRerun()" class="btn" id="rerun-btn" style="background: rgba(255, 255, 255, 0.9); color: #764ba2;">
            Re-run (Overwrite Cache)
        </button>
        <button onclick="killProcessing()" class="btn kill-btn" id="kill-btn" style="display: none;">
            Kill Process
        </button>
        <input 
            type="number" 
            id="max-papers" 
            class="run-input" 
            placeholder="Max papers (optional)"
            min="1"
        >
        <div id="job-status" class="status-indicator status-idle">Idle</div>
    </div>
    <div id="job-message" class="job-message"></div>
    <div id="progress-output" class="progress-output"></div>
</div>

<div class="card">
    <h2 style="margin-bottom: 15px;">Quick Actions</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="{{ url_for('interests_page') }}" class="btn">Edit Interests</a>
        <a href="{{ url_for('config_page') }}" class="btn">Edit Config</a>
        <a href="{{ url_for('papers_page') }}" class="btn">Browse Papers</a>
    </div>
</div>

<div class="card">
    <h2 style="margin-bottom: 15px;">Getting Started</h2>
    <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">
        You can process papers either from the command line or using the "Run Paper Processing" button above.
    </p>
    <pre style="background: #f0f0f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 14px;">archeion_now</pre>
    <p style="color: #666; line-height: 1.6; margin-top: 15px;">
        The processed papers will appear in the Papers section.
    </p>
</div>

<script>
let statusCheckInterval = null;
let accumulatedProgress = [];

async function startProcessing() {
    const maxPapers = document.getElementById('max-papers').value;
    const runBtn = document.getElementById('run-btn');
    const rerunBtn = document.getElementById('rerun-btn');
    const statusDiv = document.getElementById('job-status');
    const messageDiv = document.getElementById('job-message');
    const progressOutput = document.getElementById('progress-output');
    
    // Clear previous progress
    progressOutput.innerHTML = '';
    progressOutput.classList.remove('active');
    accumulatedProgress = [];
    
    runBtn.disabled = true;
    rerunBtn.disabled = true;
    runBtn.textContent = 'Starting...';
    
    try {
        const response = await fetch('/api/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                max_papers: maxPapers || null
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.textContent = 'Processing started...';
            startStatusPolling();
        } else {
            messageDiv.textContent = `Error: ${data.error}`;
            runBtn.disabled = false;
            rerunBtn.disabled = false;
            runBtn.textContent = 'Start Processing';
        }
    } catch (error) {
        messageDiv.textContent = `Error: ${error.message}`;
        runBtn.disabled = false;
        rerunBtn.disabled = false;
        runBtn.textContent = 'Start Processing';
    }
}

async function startRerun() {
    if (!confirm('Re-run will reprocess all papers and overwrite existing cache entries. Continue?')) {
        return;
    }
    
    const maxPapers = document.getElementById('max-papers').value;
    const runBtn = document.getElementById('run-btn');
    const rerunBtn = document.getElementById('rerun-btn');
    const statusDiv = document.getElementById('job-status');
    const messageDiv = document.getElementById('job-message');
    const progressOutput = document.getElementById('progress-output');
    
    // Clear previous progress
    progressOutput.innerHTML = '';
    progressOutput.classList.remove('active');
    accumulatedProgress = [];
    
    runBtn.disabled = true;
    rerunBtn.disabled = true;
    rerunBtn.textContent = 'Starting re-run...';
    
    try {
        const response = await fetch('/api/rerun', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                max_papers: maxPapers || null
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.textContent = 'Re-run processing started (cache will be overwritten)...';
            startStatusPolling();
        } else {
            messageDiv.textContent = `Error: ${data.error}`;
            runBtn.disabled = false;
            rerunBtn.disabled = false;
            rerunBtn.textContent = 'Re-run (Overwrite Cache)';
        }
    } catch (error) {
        messageDiv.textContent = `Error: ${error.message}`;
        runBtn.disabled = false;
        rerunBtn.disabled = false;
        rerunBtn.textContent = 'Re-run (Overwrite Cache)';
    }
}

async function checkStatus() {
    try {
        const response = await fetch('/api/run/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('job-status');
        const messageDiv = document.getElementById('job-message');
        const runBtn = document.getElementById('run-btn');
        const rerunBtn = document.getElementById('rerun-btn');
        
        // Update status indicator
        statusDiv.className = 'status-indicator';
        const killBtn = document.getElementById('kill-btn');
        const progressOutput = document.getElementById('progress-output');
        
        if (data.running) {
            statusDiv.className += ' status-running';
            statusDiv.textContent = 'Running';
            runBtn.disabled = true;
            rerunBtn.disabled = true;
            runBtn.textContent = 'Processing...';
            rerunBtn.textContent = 'Re-run (Overwrite Cache)';
            killBtn.style.display = 'inline-block';
            progressOutput.classList.add('active');
        } else {
            killBtn.style.display = 'none';
            if (data.status === 'completed') {
                statusDiv.className += ' status-completed';
                statusDiv.textContent = 'Completed';
                runBtn.disabled = false;
                rerunBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                rerunBtn.textContent = 'Re-run (Overwrite Cache)';
                stopStatusPolling();
                // Keep progress visible for a bit, then hide
                setTimeout(() => {
                    progressOutput.classList.remove('active');
                }, 5000);
            } else if (data.status === 'error') {
                statusDiv.className += ' status-error';
                statusDiv.textContent = 'Error';
                runBtn.disabled = false;
                rerunBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                rerunBtn.textContent = 'Re-run (Overwrite Cache)';
                stopStatusPolling();
            } else if (data.status === 'killed') {
                statusDiv.className += ' status-killed';
                statusDiv.textContent = 'Killed';
                runBtn.disabled = false;
                rerunBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                rerunBtn.textContent = 'Re-run (Overwrite Cache)';
                stopStatusPolling();
            } else {
                statusDiv.className += ' status-idle';
                statusDiv.textContent = 'Idle';
                runBtn.disabled = false;
                rerunBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                rerunBtn.textContent = 'Re-run (Overwrite Cache)';
                progressOutput.classList.remove('active');
            }
        }
        
        // Update message
        if (data.message) {
            messageDiv.textContent = data.message;
        } else {
            messageDiv.textContent = '';
        }
        
        // Update progress output
        if (data.progress && data.progress.length > 0) {
            const progressContainer = progressOutput;
            data.progress.forEach(msg => {
                // Add to accumulated progress
                accumulatedProgress.push(msg);
                const line = document.createElement('div');
                line.className = 'progress-line';
                if (msg.type === 'status') {
                    line.className += ' status';
                } else if (msg.type === 'error') {
                    line.className += ' error';
                }
                line.textContent = msg.content;
                progressContainer.appendChild(line);
            });
            // Keep only last 1000 lines to prevent memory issues
            if (accumulatedProgress.length > 1000) {
                const toRemove = accumulatedProgress.length - 1000;
                for (let i = 0; i < toRemove; i++) {
                    if (progressContainer.firstChild) {
                        progressContainer.removeChild(progressContainer.firstChild);
                    }
                }
                accumulatedProgress = accumulatedProgress.slice(toRemove);
            }
            // Auto-scroll to bottom
            progressContainer.scrollTop = progressContainer.scrollHeight;
        }
        
        // If completed or error, reload page after a delay to refresh paper count
        if (!data.running && (data.status === 'completed' || data.status === 'error')) {
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

function startStatusPolling() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    statusCheckInterval = setInterval(checkStatus, 2000);
    checkStatus(); // Check immediately
}

function stopStatusPolling() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
    }
}

async function killProcessing() {
    if (!confirm('Are you sure you want to kill the running process? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/run/kill', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            document.getElementById('job-message').textContent = 'Termination signal sent...';
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

// Check status on page load
window.addEventListener('DOMContentLoaded', () => {
    checkStatus();
    // Poll every 2 seconds if running
    setInterval(() => {
        fetch('/api/run/status')
            .then(r => r.json())
            .then(data => {
                if (data.running) {
                    checkStatus();
                }
            });
    }, 2000);
});
</script>
{% endblock %}

