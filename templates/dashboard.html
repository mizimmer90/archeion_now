{% extends "base.html" %}

{% block title %}Dashboard - Archeion Now{% endblock %}

{% block extra_css %}
<style>
    .run-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    
    .run-section h3 {
        margin-bottom: 15px;
        color: white;
    }
    
    .run-controls {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .run-input {
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        width: 120px;
    }
    
    .status-indicator {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 13px;
        font-weight: 500;
    }
    
    .status-idle {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .status-running {
        background: #ffc107;
        color: #333;
        animation: pulse 2s infinite;
    }
    
    .status-completed {
        background: #28a745;
    }
    
    .status-error {
        background: #dc3545;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    .job-message {
        margin-top: 10px;
        font-size: 14px;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<h2 style="margin-bottom: 30px; color: #333;">Dashboard</h2>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
    <div class="card">
        <h3 style="margin-bottom: 10px; color: #667eea;">ðŸ“„ Papers</h3>
        <p style="font-size: 32px; font-weight: bold; color: #333;">{{ paper_count }}</p>
        <p style="color: #666; margin-top: 5px;">Total papers processed</p>
    </div>
</div>

<div class="run-section">
    <h3>ðŸš€ Run Paper Processing</h3>
    <div class="run-controls">
        <button onclick="startProcessing()" class="btn" id="run-btn" style="background: white; color: #667eea;">
            Start Processing
        </button>
        <input 
            type="number" 
            id="max-papers" 
            class="run-input" 
            placeholder="Max papers (optional)"
            min="1"
        >
        <div id="job-status" class="status-indicator status-idle">Idle</div>
    </div>
    <div id="job-message" class="job-message"></div>
</div>

<div class="card">
    <h2 style="margin-bottom: 15px;">Quick Actions</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="{{ url_for('interests_page') }}" class="btn">Edit Interests</a>
        <a href="{{ url_for('config_page') }}" class="btn">Edit Config</a>
        <a href="{{ url_for('papers_page') }}" class="btn">Browse Papers</a>
    </div>
</div>

<div class="card">
    <h2 style="margin-bottom: 15px;">Getting Started</h2>
    <p style="color: #666; line-height: 1.6; margin-bottom: 15px;">
        You can process papers either from the command line or using the "Run Paper Processing" button above.
    </p>
    <pre style="background: #f0f0f0; padding: 15px; border-radius: 6px; overflow-x: auto; font-family: 'Courier New', monospace; font-size: 14px;">archeion_now</pre>
    <p style="color: #666; line-height: 1.6; margin-top: 15px;">
        The processed papers will appear in the Papers section.
    </p>
</div>

<script>
let statusCheckInterval = null;

async function startProcessing() {
    const maxPapers = document.getElementById('max-papers').value;
    const runBtn = document.getElementById('run-btn');
    const statusDiv = document.getElementById('job-status');
    const messageDiv = document.getElementById('job-message');
    
    runBtn.disabled = true;
    runBtn.textContent = 'Starting...';
    
    try {
        const response = await fetch('/api/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                max_papers: maxPapers || null
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.textContent = 'Processing started...';
            startStatusPolling();
        } else {
            messageDiv.textContent = `Error: ${data.error}`;
            runBtn.disabled = false;
            runBtn.textContent = 'Start Processing';
        }
    } catch (error) {
        messageDiv.textContent = `Error: ${error.message}`;
        runBtn.disabled = false;
        runBtn.textContent = 'Start Processing';
    }
}

async function checkStatus() {
    try {
        const response = await fetch('/api/run/status');
        const data = await response.json();
        
        const statusDiv = document.getElementById('job-status');
        const messageDiv = document.getElementById('job-message');
        const runBtn = document.getElementById('run-btn');
        
        // Update status indicator
        statusDiv.className = 'status-indicator';
        if (data.running) {
            statusDiv.className += ' status-running';
            statusDiv.textContent = 'Running';
            runBtn.disabled = true;
            runBtn.textContent = 'Processing...';
        } else {
            if (data.status === 'completed') {
                statusDiv.className += ' status-completed';
                statusDiv.textContent = 'Completed';
                runBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                stopStatusPolling();
            } else if (data.status === 'error') {
                statusDiv.className += ' status-error';
                statusDiv.textContent = 'Error';
                runBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
                stopStatusPolling();
            } else {
                statusDiv.className += ' status-idle';
                statusDiv.textContent = 'Idle';
                runBtn.disabled = false;
                runBtn.textContent = 'Start Processing';
            }
        }
        
        // Update message
        if (data.message) {
            messageDiv.textContent = data.message;
        } else {
            messageDiv.textContent = '';
        }
        
        // If completed or error, reload page after a delay to refresh paper count
        if (!data.running && (data.status === 'completed' || data.status === 'error')) {
            setTimeout(() => {
                window.location.reload();
            }, 3000);
        }
    } catch (error) {
        console.error('Error checking status:', error);
    }
}

function startStatusPolling() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
    }
    statusCheckInterval = setInterval(checkStatus, 2000);
    checkStatus(); // Check immediately
}

function stopStatusPolling() {
    if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
        statusCheckInterval = null;
    }
}

// Check status on page load
window.addEventListener('DOMContentLoaded', () => {
    checkStatus();
    // Poll every 2 seconds if running
    setInterval(() => {
        fetch('/api/run/status')
            .then(r => r.json())
            .then(data => {
                if (data.running) {
                    checkStatus();
                }
            });
    }, 2000);
});
</script>
{% endblock %}

